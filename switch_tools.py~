#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import os, re
import rrd_tools
import config
default = config.configs.rrd_create_option_default
import logging

class device():
    def __init__(self, id, host, vendor, model, snmp_version='2c', snmp_community='public'):
        self._id = str(id)
        self._version = snmp_version
        self._community = snmp_community
        self._host = host
        self._base_snmpget_cmd = ('snmpget -v %s -c %s %s ' % (self._version, self._community, self._host))
        self._base_snmpwalk_cmd = ('snmpwalk -v %s -c %s %s ' % (self._version, self._community, self._host))
        self._model = vendor+'_'+model
        self._mod = __import__('switchlib.'+self._model, globals(), locals(), self._model)
        self._common_mod = __import__('switchlib.common', globals(), locals(), 'common')
        self._dir = config.configs.RRD_save_path+'/switch_id_'+str(id)
        self.logging = logging.logging(config.configs.log['path'], flag=self._host)

        def exec_snmpget(oid):
            output = ''.join(os.popen(self._base_snmpget_cmd+oid))
            if not output:
                raise RuntimeError ('Timeout: No Response from %s' % (self._host))
            return output
        self.get_oid = exec_snmpget
        self._mod.get_oid = self.get_oid    # import function : get_oid into imported model

        def exec_snmpwalk(oid):
            output = ''.join(os.popen(self._base_snmpwalk_cmd+oid))
            if not output:
                raise RuntimeError ('Timeout: No Response from %s' % (self._host))
            #print(output)
            return output
        self.walk_oid = exec_snmpwalk
        self._mod.walk_oid = self.walk_oid    # import function : walk_oid into imported model

    def create_switch_dir(self):
        fname = self._dir
        if not os.path.exists(fname):
            os.mkdir(fname)

    def get_indicator_func(self, indicator):
        func = getattr(self._mod, indicator, None)
        if func is None:
           func = getattr(self._common_mod, indicator, None)
           if func is None:
               self.logging.error('can`t find function %s in lib \'%s\' or \'common.py\'' % (name, self._mod))
        return func

    def get_indicator_value(self, indicator):
        func = self.get_indicator_func(indicator)
        if func is None:
            return None
        try:
            r = func()
        except Exception as e:
            self.logging.error('API %s Error : %s' % (func.__name__, e))
            return None
        if r is None:
            return None    # func return None means unused
        if isinstance(r, tuple):
            for each in r:
                try:
                    float(each)
                except ValueError:
                    self.logging.error('API %s returns is not a tuple ' % func.__name__)
                    return None
            return r
        else:
            self.logging.error('API %s returns is not a tuple ' % func.__name__)
            return None

    def create_rrd(self, indicator):
        func = self.get_indicator_func(indicator)
        if not os.path.exists(self._dir):
            self.create_switch_dir()
        kw = {
            'fname' : os.path.join(self._dir, indicator+'.rrd'),
            'DS' : getattr(func, 'DS', default['DS']),
            'step' : getattr(func, 'step', default['step']),
            'DST' : getattr(func, 'DST', default['DST']),
            'max' : getattr(func, 'max', default['max']),
            'min' : getattr(func, 'min', default['min']),
            'CF' : getattr(func, 'CF', default['CF']),
            'CDP' : getattr(func, 'CDP', default['CDP']),
            'size' : getattr(func, 'size', default['size'])
        }
        rrd_tools.create(**kw)

    def update_rrd(self, indicator, value):
        fname = os.path.join(self._dir, indicator+'.rrd')
        if not os.path.exists(fname):
            self.create_rrd(indicator)
        rrd_tools.update(fname=fname, value=value)

    def get_last_value(self, indicator):
        fname = os.path.join(self._dir, indicator+'.rrd')
        return rrd_tools.get_last_value(fname)

    def get_last_update(self, indicator):
        fname = os.path.join(self._dir, indicator+'.rrd')
        return rrd_tools.get_last_update(fname)

if __name__ == '__main__':
    test = device(id=1, host='10.189.72.84', vendor='cisco', model='3550', snmp_community='Oavpn@123')
    print(test.get_indicator_value('cpu'))
    print(test.get_indicator_value('memory'))
