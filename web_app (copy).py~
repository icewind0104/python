#!/usr/bin/python3
# -*- coding: utf-8 -*-

import orm
import config1
import asyncio, aiohttp
from aiohttp import web
from jinja2 import Environment, FileSystemLoader
from coroweb import add_routers
import os


def init_jinja2(app):
    path = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'template')
    app['env'] = Environment(loader=FileSystemLoader(path))

@asyncio.coroutine
def factory(app, handler):
    @asyncio.coroutine
    def response(request):
        r = yield from handler(request)
        resp = web.Response(body=app['env'].get_template(r.pop('__template__')).render(**r).encode('utf-8'))
        resp.content_type = 'text/html;charset=utf-8'
        return resp
    return response

@asyncio.coroutine
def init(loop):
    yield from orm.create_pool(loop=loop, **config.configs.db)
    app = web.Application(loop=loop, middlewares=[factory])
    init_jinja2(app)
    add_routers(app, 'handlers')
    srv = yield from loop.create_server(app.make_handler(), **config.configs.server)
    return srv

loop = asyncio.get_event_loop()
loop.run_until_complete(init(loop))
loop.run_forever()

